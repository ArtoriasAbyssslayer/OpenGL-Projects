cmake_minimum_required(VERSION 3.15)
project(OpenGL_Tutorial VERSION 1.0 LANGUAGES CXX C)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# Add include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/include/headers
)

# Find OpenGL
find_package(OpenGL REQUIRED)

# Platform-specific library paths
if(WIN32)
    link_directories(${CMAKE_SOURCE_DIR}/lib)
elseif(APPLE)
    link_directories(${CMAKE_SOURCE_DIR}/lib)
elseif(UNIX)
    link_directories(${CMAKE_SOURCE_DIR}/lib)
endif()

# Automatically find all source files
file(GLOB_RECURSE SOURCES
    "${CMAKE_SOURCE_DIR}/src/*.cpp"
    "${CMAKE_SOURCE_DIR}/src/*.c"
)

# Automatically find all header files
file(GLOB_RECURSE HEADERS
    "${CMAKE_SOURCE_DIR}/include/**/*.h"
)

# Print found files for debugging
message(STATUS "Found source files: ${SOURCES}")
message(STATUS "Found header files: ${HEADERS}")

# Create executable
add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})

# Include directories
target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/include/headers
    ${CMAKE_SOURCE_DIR}/Libraries/include
    ${OPENGL_INCLUDE_DIR}
)

# Link libraries
target_link_libraries(${PROJECT_NAME} PRIVATE
    ${OPENGL_LIBRARIES}
)

# Platform-specific linking
if(WIN32)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        glfw3
    )
    # Copy DLLs to output directory if needed
    if(EXISTS ${CMAKE_SOURCE_DIR}/lib/glfw3.dll)
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${CMAKE_SOURCE_DIR}/lib/glfw3.dll"
            $<TARGET_FILE_DIR:${PROJECT_NAME}>
        )
    endif()
elseif(APPLE)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        glfw
    )
    # Link required frameworks on macOS
    find_library(COCOA_LIBRARY Cocoa)
    find_library(IOKIT_LIBRARY IOKit)
    find_library(COREVIDEO_LIBRARY CoreVideo)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ${COCOA_LIBRARY}
        ${IOKIT_LIBRARY}
        ${COREVIDEO_LIBRARY}
    )
elseif(UNIX)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        glfw
        dl
        pthread
        X11
    )
endif()

# Compiler warnings
if(MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE /W4)
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -Wall -Wextra -Wpedantic)
endif()

# Copy shader files to build directory if they exist
file(GLOB SHADER_FILES 
    "${CMAKE_SOURCE_DIR}/Shaders/*.vert"
    "${CMAKE_SOURCE_DIR}/Shaders/*.frag"
    "${CMAKE_SOURCE_DIR}/Shaders/*.geom"
    "${CMAKE_SOURCE_DIR}/Shaders/*.comp"
    "${CMAKE_SOURCE_DIR}/Shaders/*.glsl"
)

foreach(SHADER ${SHADER_FILES})
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${SHADER}
        $<TARGET_FILE_DIR:${PROJECT_NAME}>
    )
endforeach()

# Installation rules (optional)
install(TARGETS ${PROJECT_NAME} DESTINATION bin)
install(FILES ${SHADER_FILES} DESTINATION bin)